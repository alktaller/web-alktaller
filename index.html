<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>AlkTaller</title>
  <link rel="icon" href="images/icono.png">
  <link rel="stylesheet" href="css/style.css?v=2">
  <style>
    /* Critical Internal CSS to prevent FOUC / Cache issues */
    .tab-content { display: none; }
    .tab-content.active { display: block; animation: fadeIn 0.3s; }
    @keyframes fadeIn { from{opacity:0} to{opacity:1} }
    .tab-menu { display: flex; gap: 10px; padding: 10px 0; border-bottom: 2px solid #E2E8F0; margin-bottom: 20px; overflow-x: auto; }
    .tab-btn { background:none; border:none; padding:10px 20px; font-weight:600; cursor:pointer; color:#718096; }
    .tab-btn.active { color:#FF8C00; border-bottom: 2px solid #FF8C00; }
  </style>
</head>
<body>

<div id="login-screen" class="hidden">
  <div class="login-container">
    <img src="images/logo.png" alt="AlkTaller Logo" class="login-logo">
    <h2>Bienvenido a AlkTaller</h2>
    <p>Introduce tu Token de Acceso para desbloquear tus datos.</p>
    
    <div class="input-group">
      <input type="password" id="githubTokenInput" placeholder="ghp_...">
      <button onclick="handleLogin()" class="btn-primary">Entrar</button>
    </div>
  </div>
</div>

<div id="app-container" class="hidden">
  <header>
    <div class="logo-area">
      <img src="images/logo.png" alt="AlkTaller" class="app-logo">
      <h1>AlkTaller</h1>
    </div>
    <div class="user-area">
      <button onclick="logout()" class="btn-secondary">
          <svg class="icon" viewBox="0 0 24 24"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
          Salir
      </button>
    </div>
  </header>

  <main>
    <div class="dashboard-controls">
      <select id="vehicleSelect"></select>
      <div class="action-buttons">
        <button onclick="addVehicle()" class="btn-primary">
            <svg class="icon" viewBox="0 0 24 24" style="stroke:white"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
            AÃ±adir coche
        </button>
        <button onclick="saveData(data)" class="btn-success">
            <svg class="icon" viewBox="0 0 24 24" style="stroke:white"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v13a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>
            Guardar cambios
        </button>
      </div>
    </div>

    <!-- Navigation Menu -->
    <nav class="tab-menu">
      <button class="tab-btn active" onclick="openTab('dashboard')">
        <svg class="icon" viewBox="0 0 24 24"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg>
        Resumen
      </button>
      <button class="tab-btn" onclick="openTab('actions')">
        <svg class="icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="16"></line><line x1="8" y1="12" x2="16" y2="12"></line></svg>
        Operaciones
      </button>
      <button class="tab-btn" onclick="openTab('reminders')">
        <svg class="icon" viewBox="0 0 24 24"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path><path d="M13.73 21a2 2 0 0 1-3.46 0"></path></svg>
        Recordatorios
      </button>
      <button class="tab-btn" onclick="openTab('history')">
        <svg class="icon" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
        Historial
      </button>
    </nav>

    <!-- Tab 1: Dashboard (Stats + Vehicle Info) -->
    <div id="dashboard" class="tab-content active">
        <section class="card">
          <h2>
            <svg class="icon" viewBox="0 0 24 24"><line x1="18" y1="20" x2="18" y2="10"></line><line x1="12" y1="20" x2="12" y2="4"></line><line x1="6" y1="20" x2="6" y2="14"></line></svg> 
            EstadÃ­sticas
          </h2>
          <div id="stats"></div>
        </section>

        <section class="card">
          <h2>
            <svg class="icon" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg> 
            InformaciÃ³n del VehÃ­culo
          </h2>
          <div class="form-group" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
            <div>
              <label>MatrÃ­cula</label>
              <input id="infoPlate" type="text" placeholder="0000 XXX" onchange="updateVehicleInfo('plate', this.value)">
            </div>
            <div>
              <label>VIN (Bastidor)</label>
              <input id="infoVin" type="text" placeholder="VIN..." onchange="updateVehicleInfo('vin', this.value)">
            </div>
            <div>
              <label>Fecha MatriculaciÃ³n</label>
              <input id="infoRegDate" type="date" onchange="updateVehicleInfo('regDate', this.value)">
            </div>
            <div>
              <label>Fecha Compra</label>
              <input id="infoPurchaseDate" type="date" onchange="updateVehicleInfo('purchaseDate', this.value)">
            </div>
            <div>
              <label>Kilometraje Actual</label>
              <div style="display: flex; gap: 5px;">
                <input id="infoOdo" type="number" placeholder="km" onchange="updateVehicleOdometer(this.value)">
                <button onclick="updateVehicleOdometer(document.getElementById('infoOdo').value)" class="btn-secondary" title="Actualizar">ðŸ’¾</button>
              </div>
            </div>
            <div>
              <label>CompaÃ±Ã­a Seguros</label>
              <input id="infoInsuranceCompany" type="text" placeholder="CompaÃ±Ã­a..." onchange="updateVehicleInfo('insuranceCompany', this.value)">
            </div>
            <div>
              <label>NÂº PÃ³liza</label>
              <input id="infoInsurancePolicy" type="text" placeholder="PÃ³liza..." onchange="updateVehicleInfo('insurancePolicy', this.value)">
            </div>
            <div style="grid-column: 1 / -1;">
                <label>Documento PÃ³liza</label>
                <div style="display:flex; align-items:center; gap:10px;">
                    <a id="linkViewPolicy" href="#" target="_blank" class="btn-secondary" style="display:none; text-decoration:none; display:flex; align-items:center; gap:5px;">
                       ðŸ“„ Ver PÃ³liza
                    </a>
                    <label for="infoInsuranceFile" class="btn-secondary" style="cursor:pointer; display:flex; align-items:center; gap:5px;">
                        <svg class="icon" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
                        Subir/Cambiar Foto
                    </label>
                    <input id="infoInsuranceFile" type="file" accept="image/*,application/pdf" onchange="uploadVehiclePolicy(this)" style="display:none;">
                    <span id="uploadStatus" style="font-size:0.85rem; color:#64748b;"></span>
                </div>
            </div>
          </div>
          <div class="form-group mt-2">
             <label>Notas</label>
             <textarea id="infoNotes" style="width:100%; padding:0.5rem; border:1px solid var(--border-color); border-radius:4px;" rows="2" placeholder="Notas adicionales..." onchange="updateVehicleInfo('notes', this.value)"></textarea>
          </div>
          
          <div class="form-group mt-2" style="text-align: right;">
              <button onclick="exportVehiclePDF()" class="btn-secondary" style="border: 1px solid var(--border-color);">
                <svg class="icon" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
                Exportar Informe PDF
              </button>
          </div>
        </section>
    </div>

    <!-- Tab 2: Actions (Fuel + Maintenance) -->
    <div id="actions" class="tab-content">
        <div class="forms-grid">
            <section class="card">
              <h2>
                <svg class="icon" viewBox="0 0 24 24"><path d="M3 21.01h.01"></path><path d="M9 21.01h.01"></path><path d="M15 21.01h.01"></path><path d="M21 21.01h.01"></path><path d="M4 21a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v15a2 2 0 0 1-2 2"></path><path d="M3 11h18"></path><path d="M15 11v10"></path></svg>
                Nuevo repostaje
              </h2>
              <div class="form-group">
                <input id="fuelDate" type="date">
                <input id="fuelOdo" type="number" placeholder="KilÃ³metros">
                <input id="fuelLiters" type="number" placeholder="Litros">
                <input id="fuelCost" type="number" placeholder="Coste total (â‚¬)">
                <div style="display:flex; align-items:center; gap:10px; margin: 5px 0;">
                    <input type="checkbox" id="fuelIsFull" checked style="width:auto; margin:0;">
                    <label for="fuelIsFull">DepÃ³sito Lleno</label>
                </div>
                <button onclick="addFuel()" class="btn-primary">
                    <svg class="icon" viewBox="0 0 24 24" style="stroke:white"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v13a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>
                    Guardar repostaje
                </button>
              </div>
            </section>

            <section class="card">
              <h2>
                <svg class="icon" viewBox="0 0 24 24"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"></path></svg>
                Nuevo mantenimiento
              </h2>
              <div class="form-group">
                <input id="maintDate" type="date">
                <!-- Select para categorÃ­as existentes y Input para nueva categorÃ­a (fallback/hÃ­brido) -->
                <div style="display:flex; gap:5px;">
                    <select id="maintTypeSelect" onchange="document.getElementById('maintType').value=this.value; if(this.value==='') document.getElementById('maintType').focus();" style="flex:1;">
                        <option value="" disabled selected>Seleccionar Tipo...</option>
                    </select>
                </div>
                <input id="maintType" type="text" placeholder="O escribe otro tipo..." style="margin-top:5px;">
                
                <input id="maintOdo" type="number" placeholder="KilÃ³metros">
                <input id="maintCost" type="number" placeholder="Coste (â‚¬)">
                
                <input id="maintGarage" type="text" placeholder="Notas / Taller (Â¿DÃ³nde se realizÃ³?)">
                <div style="display:flex; align-items:center; gap:10px; margin-top:5px;">
                    <label style="font-size:0.9rem; color:var(--text-color);">ðŸ§¾ Ticket:</label>
                    <input id="maintTicket" type="file" accept="image/*" style="flex:1;">
                </div>

                <button onclick="addMaintenance()" class="btn-primary" style="margin-top:10px;">
                    <svg class="icon" viewBox="0 0 24 24" style="stroke:white"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v13a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>
                    Guardar mantenimiento
                </button>
              </div>
            </section>
        </div>
    </div>

    <!-- Tab 3: Reminders -->
    <div id="reminders" class="tab-content">
        <section class="card">
          <h2>
            <svg class="icon" viewBox="0 0 24 24"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path><path d="M13.73 21a2 2 0 0 1-3.46 0"></path></svg>
            Recordatorios
          </h2>
          <div class="table-responsive">
            <table id="reminderTable">
              <thead>
                <tr>
                  <th>TÃ­tulo</th>
                  <th>Frecuencia (km)</th>
                  <th>Tiempo</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
          <button onclick="addReminder()" class="btn-secondary mt-2">
            <svg class="icon" viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
            AÃ±adir recordatorio
          </button>
        </section>
    </div>

    <!-- Tab 4: History -->
    <div id="history" class="tab-content">
        <section class="card">
          <h2>
            <svg class="icon" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
            Historial
          </h2>
          <ul id="timeline"></ul>
        </section>
    </div>
  </main>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

<script src="js/storage.js?v=8"></script>
<script src="js/app.js?v=8"></script>

</body>
</html>
